/* eslint-disable no-undef */
import { Button } from '@mui/material'
import Head from 'next/head'
import { useRouter } from 'next/router'
import { useContext } from 'react'
import { conf } from '../../configuration'
import { PdrContext } from '../../context/PdrContext'
import { TownContext } from '../../context/TownContext'
import { WeightContext } from '../../context/WeightContext'
import { BUCKET_NAME } from './google'

function OpenFile (props) {
  const router = useRouter()
  const { setPdr } = useContext(PdrContext)
  const { town } = useContext(TownContext)
  const { setWeight } = useContext(WeightContext)

  const file = conf[town].file

  const bucket = town === 'sample' ? 'reciclaplus-public' : BUCKET_NAME

  function downloadFunction () {
    const request = gapi.client.request({
      path: `https://storage.googleapis.com/storage/v1/b/${bucket}/o/${file}?alt=media`,
      method: 'GET',
      headers: {
        Accept: 'application/json'
        // "Authorization": "Bearer " + props.googleauth.currentUser.Nb.wc.access_token
      }
    })
    return request.execute(function (file, rawResponse) {
      if (JSON.parse(rawResponse).gapiRequest.data.status === 200) {
        setPdr(file.pdr)
        setWeight(file.peso)
        router.push('/list')
      } else {
        alert('Con√©ctate para abrir el archivo')
        console.log(JSON.parse(rawResponse))
      }
    })
  }

  return (<>
        <Head>

        <meta name="description" content="Generated by create next app" />

        </Head>

        <Button id="open-btn" variant="contained" onClick={downloadFunction}>Abrir</Button>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

        </>
  )
}

export default OpenFile
